{% extends 'base.html' %}
{% load static %}

{% block title %}চেকআউট - আমার ফ্রেশ বিডি{% endblock %}

{% block content %}
<!-- Facebook Pixel Cart Data -->
{% if FACEBOOK_PIXEL_ID and FACEBOOK_PIXEL_ENABLED and cart_items %}
<script>
window.FACEBOOK_PIXEL_DEBUG = {{ FACEBOOK_PIXEL_DEBUG|yesno:"true,false" }};
window.cartData = {
    total: {{ cart.total_price|default:0 }},
    items: [
        {% for item in cart_items %}
        {
            product_id: '{{ item.product.id }}',
            name: '{{ item.product.name|escapejs }}',
            category: '{{ item.product.category.name|escapejs }}',
            price: {{ item.product.discount_price|default:item.product.price }},
            quantity: {{ item.quantity }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ]
};
</script>
{% endif %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Checkout Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">চেকআউট</h1>
            <p class="mt-2 text-gray-600">নিরাপদ পেমেন্টের মাধ্যমে আপনার অর্ডার সম্পন্ন করুন</p>
        </div>

        <div class="lg:grid lg:grid-cols-12 lg:gap-x-12 lg:items-start">
            <!-- Order Summary -->
            <div class="lg:col-span-7">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">অর্ডার সারসংক্ষেপ</h2>
                    </div>
                    
                    <div class="p-6">
                        {% if cart_items %}
                        <div class="space-y-4">
                            {% for item in cart_items %}
                            <div class="flex items-center space-x-4 py-4 border-b border-gray-100 last:border-b-0">
                                <div class="flex-shrink-0">
                                    {% if item.product.image %}
                                      <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" 
                                           class="w-16 h-16 object-cover rounded-lg">
                                    {% else %}
                                      <div class="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center">
                                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                      </div>
                                    {% endif %}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-sm font-medium text-gray-900 truncate">{{ item.product.name }}</h3>
                                    <p class="text-sm text-gray-500 mt-1">
                                        {% if item.product.is_on_sale %}
                                            ৳{{ item.product.discount_price }} প্রতিটি
                                        {% else %}
                                            ৳{{ item.product.price }} প্রতিটি
                                        {% endif %}
                                    </p>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <span class="text-sm text-gray-500">পরিমাণ: {{ item.quantity }}</span>
                                    <span class="text-sm font-medium text-gray-900">
                                        ৳{{ item.total_price|floatformat:2 }}
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Order Totals -->
                        <div class="mt-6 space-y-3 border-t border-gray-200 pt-6">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">সাবটোটাল</span>
                                <span class="text-gray-900" id="subtotal">৳{{ cart.total_price|floatformat:2 }}</span>
                            </div>
                            <div class="flex justify-between text-sm" id="discountRow" style="display: none;">
                                <span class="text-gray-600">ছাড়</span>
                                <span class="text-green-600" id="discountAmount">-৳0.00</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">ডেলিভারি চার্জ</span>
                                <span class="text-gray-900">৳0.00</span>
                            </div>
                            <div class="flex justify-between text-base font-semibold border-t border-gray-200 pt-3">
                                <span class="text-gray-900">মোট</span>
                                <span class="text-gray-900" id="finalTotal">৳{{ cart.total_price|floatformat:2 }}</span>
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center py-8">
                            <p class="text-gray-500">আপনার কার্ট খালি</p>
                            <a href="{% url 'product_list' %}" class="mt-4 inline-block bg-[oklch(0.696_0.17_162.48)] text-white px-6 py-2 rounded-lg hover:bg-[oklch(0.596_0.17_162.48)] transition">
                                কেনাকাটা চালিয়ে যান
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Checkout Form -->
            <div class="mt-10 lg:mt-0 lg:col-span-5">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">ডেলিভারি তথ্য</h2>
                    </div>
                    
                    <div class="p-6">
                        {% if cart_items %}
                        <form method="post" id="checkoutForm" class="space-y-6">
                            {% csrf_token %}
                            
                            <!-- Customer Information -->
                            <div class="grid grid-cols-1 gap-6">
                                <!-- Full Name -->
                                <div>
                                    <label for="{{ form.full_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        পূর্ণ নাম *
                                    </label>
                                    {{ form.full_name }}
                                    {% if form.full_name.errors %}
                                    <div class="mt-1 text-sm text-red-600">
                                        {{ form.full_name.errors }}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Email -->
                                <div>
                                    <label for="{{ form.email.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        ইমেইল ঠিকানা *
                                    </label>
                                    {{ form.email }}
                                    {% if form.email.errors %}
                                    <div class="mt-1 text-sm text-red-600">
                                        {{ form.email.errors }}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Phone -->
                                <div>
                                    <label for="{{ form.phone.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        ফোন নম্বর *
                                    </label>
                                    {{ form.phone }}
                                    {% if form.phone.errors %}
                                    <div class="mt-1 text-sm text-red-600">
                                        {{ form.phone.errors }}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Delivery Address -->
                                <div>
                                    <label for="{{ form.address.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        ডেলিভারি ঠিকানা *
                                    </label>
                                    {{ form.address }}
                                    {% if form.address.errors %}
                                    <div class="mt-1 text-sm text-red-600">
                                        {{ form.address.errors }}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Special Instructions -->
                                <div>
                                    <label for="{{ form.special_instructions.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        বিশেষ নির্দেশনা
                                    </label>
                                    {{ form.special_instructions }}
                                    <p class="mt-1 text-sm text-gray-500">
                                        ডেলিভারি ম্যানের জন্য কোন বিশেষ নির্দেশনা বা নোট।
                                    </p>
                                </div>
                            </div>

                            <!-- Coupon Code -->
                            <div class="border-t border-gray-200 pt-6">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">কুপন কোড</h3>
                                <div class="flex space-x-2">
                                    <input type="text" id="couponCode" placeholder="কুপন কোড লিখুন" 
                                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[oklch(0.696_0.17_162.48)]">
                                    <button type="button" id="applyCoupon" 
                                            class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
                                        প্রয়োগ করুন
                                    </button>
                                </div>
                                <div id="couponMessage" class="mt-2 text-sm hidden"></div>
                            </div>

                            <!-- Payment Method -->
                            <div class="border-t border-gray-200 pt-6">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">পেমেন্ট পদ্ধতি</h3>
                                
                                <div class="space-y-4">
                                    <!-- Cash on Delivery -->
                                    <div class="relative">
                                        <input class="sr-only" id="cash_on_delivery" type="radio" name="payment_method" value="cash" checked>
                                        <label class="flex cursor-pointer rounded-lg border border-gray-300 bg-white p-4 focus:outline-none"
                                               for="cash_on_delivery">
                                            <span class="flex flex-1">
                                                <span class="flex flex-col">
                                                    <span class="block text-sm font-medium text-gray-900">ক্যাশ অন ডেলিভারি</span>
                                                    <span class="mt-1 flex items-center text-sm text-gray-500">
                                                        পণ্য পাওয়ার সময় টাকা দিন
                                                    </span>
                                                </span>
                                            </span>
                                            <svg class="h-5 w-5 text-[oklch(0.696_0.17_162.48)]" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.236 4.53L6.53 10.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z" clip-rule="evenodd" />
                                            </svg>
                                        </label>
                                    </div>

                                    <!-- Credit Card (Coming Soon) -->
                                    <div class="relative opacity-50">
                                        <input class="sr-only" id="credit_card" type="radio" name="payment_method" value="card" disabled>
                                        <label class="flex cursor-not-allowed rounded-lg border border-gray-300 bg-gray-50 p-4"
                                               for="credit_card">
                                            <span class="flex flex-1">
                                                <span class="flex flex-col">
                                                    <span class="block text-sm font-medium text-gray-900">ক্রেডিট/ডেবিট কার্ড</span>
                                                    <span class="mt-1 flex items-center text-sm text-gray-500">
                                                        আপনার কার্ড দিয়ে নিরাপদে পেমেন্ট করুন
                                                        <span class="ml-2 inline-flex items-center rounded-full bg-yellow-100 px-2.5 py-0.5 text-xs font-medium text-yellow-800">
                                                            শীঘ্রই আসছে
                                                        </span>
                                                    </span>
                                                </span>
                                            </span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Terms and Conditions -->
                            <div class="border-t border-gray-200 pt-6">
                                <div class="flex items-start">
                                    <div class="flex items-center h-5">
                                        <input id="terms" name="terms" type="checkbox" checked 
                                               class="focus:ring-[oklch(0.696_0.17_162.48)] h-4 w-4 text-[oklch(0.696_0.17_162.48)] border-gray-300 rounded">
                                    </div>
                                    <div class="ml-3 text-sm">
                                        <label for="terms" class="font-medium text-gray-700">
                                            আমি সম্মত আছি 
                                            <a href="/terms" class="text-[oklch(0.696_0.17_162.48)] hover:text-[oklch(0.596_0.17_162.48)]">
                                                শর্তাবলী
                                            </a>
                                            এবং 
                                            <a href="/privacy" class="text-[oklch(0.696_0.17_162.48)] hover:text-[oklch(0.596_0.17_162.48)]">
                                                গোপনীয়তা নীতি
                                            </a>
                                        </label>
                                        <p class="text-gray-500 mt-1">
                                            আপনি আমাদের সেবার শর্তাবলী এবং গোপনীয়তা নীতিতে সম্মত।
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <div class="border-t border-gray-200 pt-6">
                                <input type="hidden" name="coupon_code" id="appliedCouponCode" value="">
                                <input type="hidden" name="discount_amount" id="appliedDiscountAmount" value="0">
                                
                                <button type="submit" 
                                        id="placeOrderBtn"
                                        class="w-full bg-[oklch(0.696_0.17_162.48)] text-white py-3 px-4 rounded-lg font-medium hover:bg-[oklch(0.596_0.17_162.48)] transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[oklch(0.696_0.17_162.48)] disabled:opacity-50 disabled:cursor-not-allowed">
                                    অর্ডার করুন - <span id="orderButtonTotal">৳{{ cart.total_price|floatformat:2 }}</span>
                                </button>
                                
                                <p class="mt-3 text-center text-sm text-gray-500">
                                    আপনার অর্ডার নিরাপদে প্রক্রিয়া করা হবে এবং আপনি একটি নিশ্চিতকরণ ইমেইল পাবেন।
                                </p>
                            </div>
                        </form>
                        {% endif %}
                    </div>
                </div>

                <!-- Security Badges -->
                <div class="mt-6 text-center">
                    <div class="flex justify-center space-x-6">
                        <div class="flex items-center text-sm text-gray-500">
                            <svg class="h-5 w-5 text-green-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                            </svg>
                            নিরাপদ পেমেন্ট
                        </div>
                        <div class="flex items-center text-sm text-gray-500">
                            <svg class="h-5 w-5 text-green-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                            </svg>
                            গোপনীয়তা সুরক্ষিত
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkoutForm = document.getElementById('checkoutForm');
    const placeOrderBtn = document.getElementById('placeOrderBtn');
    const applyCouponBtn = document.getElementById('applyCoupon');
    const couponCodeInput = document.getElementById('couponCode');
    const couponMessage = document.getElementById('couponMessage');
    
    let currentDiscount = 0;
    let originalTotal = {{ cart.total_price|default:0 }};
    
    // Apply coupon functionality
    if (applyCouponBtn) {
        applyCouponBtn.addEventListener('click', function() {
            const couponCode = couponCodeInput.value.trim();
            if (!couponCode) {
                showCouponMessage('দয়া করে একটি কুপন কোড লিখুন', 'error');
                return;
            }
            
            applyCouponBtn.disabled = true;
            applyCouponBtn.textContent = 'প্রয়োগ করা হচ্ছে...';
            
            fetch('/apply-coupon/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    coupon_code: couponCode,
                    cart_total: originalTotal
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentDiscount = data.discount_amount;
                    updateOrderTotals(data.discount_amount);
                    showCouponMessage(`কুপন প্রয়োগ হয়েছে! আপনি ৳${data.discount_amount} সাশ্রয় করেছেন`, 'success');
                    
                    // Store applied coupon
                    document.getElementById('appliedCouponCode').value = couponCode;
                    document.getElementById('appliedDiscountAmount').value = data.discount_amount;
                    
                    couponCodeInput.disabled = true;
                    applyCouponBtn.textContent = 'প্রয়োগ হয়েছে';
                } else {
                    showCouponMessage(data.message || 'অবৈধ কুপন কোড', 'error');
                }
            })
            .catch(error => {
                showCouponMessage('কুপন প্রয়োগে ত্রুটি। আবার চেষ্টা করুন।', 'error');
            })
            .finally(() => {
                applyCouponBtn.disabled = false;
                if (applyCouponBtn.textContent !== 'প্রয়োগ হয়েছে') {
                    applyCouponBtn.textContent = 'প্রয়োগ করুন';
                }
            });
        });
    }
    
    function showCouponMessage(message, type) {
        couponMessage.textContent = message;
        couponMessage.className = `mt-2 text-sm ${type === 'success' ? 'text-green-600' : 'text-red-600'}`;
        couponMessage.classList.remove('hidden');
    }
    
    function updateOrderTotals(discountAmount) {
        const discountRow = document.getElementById('discountRow');
        const discountAmountEl = document.getElementById('discountAmount');
        const finalTotal = document.getElementById('finalTotal');
        const orderButtonTotal = document.getElementById('orderButtonTotal');
        
        if (discountAmount > 0) {
            discountRow.style.display = 'flex';
            discountAmountEl.textContent = `-৳${discountAmount.toFixed(2)}`;
        } else {
            discountRow.style.display = 'none';
        }
        
        const newTotal = originalTotal - discountAmount;
        finalTotal.textContent = `৳${newTotal.toFixed(2)}`;
        orderButtonTotal.textContent = `৳${newTotal.toFixed(2)}`;
    }
    
    if (checkoutForm) {
        checkoutForm.addEventListener('submit', function(e) {
            // Disable the button to prevent multiple submissions
            placeOrderBtn.disabled = true;
            placeOrderBtn.innerHTML = `
                <div class="flex items-center justify-center">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    অর্ডার প্রক্রিয়া করা হচ্ছে...
                </div>
            `;
            
            // Form will submit normally
        });
    }
    
    // Add real-time validation
    const formInputs = checkoutForm?.querySelectorAll('input, textarea, select');
    if (formInputs) {
        formInputs.forEach(input => {
            input.addEventListener('blur', function() {
                validateField(this);
            });
            
            input.addEventListener('input', function() {
                clearFieldError(this);
            });
        });
    }
    
    function validateField(field) {
        const value = field.value.trim();
        const fieldName = field.name;
        
        clearFieldError(field);
        
        if (field.required && !value) {
            showFieldError(field, 'এই ক্ষেত্রটি আবশ্যক');
            return false;
        }
        
        if (fieldName === 'email' && value) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(value)) {
                showFieldError(field, 'দয়া করে একটি বৈধ ইমেইল ঠিকানা লিখুন');
                return false;
            }
        }
        
        // if (fieldName === 'phone' && value) {
        //     const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
        //     if (!phoneRegex.test(value.replace(/[\s\-\(\)]/g, ''))) {
        //         showFieldError(field, 'Please enter a valid phone number');
        //         return false;
        //     }
        // }
        
        return true;
    }
    
    function showFieldError(field, message) {
        field.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
        
        let errorDiv = field.parentNode.querySelector('.field-error');
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.className = 'field-error mt-1 text-sm text-red-600';
            field.parentNode.appendChild(errorDiv);
        }
        errorDiv.textContent = message;
    }
    
    function clearFieldError(field) {
        field.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
        field.classList.add('border-gray-300', 'focus:border-[oklch(0.696_0.17_162.48)]', 'focus:ring-[oklch(0.696_0.17_162.48)]');
        
        const errorDiv = field.parentNode.querySelector('.field-error');
        if (errorDiv) {
            errorDiv.remove();
        }
    }
    
    // Validate entire form before submission
    function validateForm() {
        let isValid = true;
        
        if (formInputs) {
            formInputs.forEach(input => {
                if (!validateField(input)) {
                    isValid = false;
                }
            });
        }
        
        const termsCheckbox = document.getElementById('terms');
        if (termsCheckbox && !termsCheckbox.checked) {
            isValid = false;
            showFieldError(termsCheckbox, 'আপনাকে অবশ্যই শর্তাবলীতে সম্মত হতে হবে');
        }
        
        return isValid;
    }
    
    // Override form submission to add validation
    if (checkoutForm) {
        checkoutForm.addEventListener('submit', function(e) {
            if (!validateForm()) {
                e.preventDefault();
                placeOrderBtn.disabled = false;
                placeOrderBtn.innerHTML = `Place Order - ${{ cart.total_price|floatformat:2 }}`;
                
                // Scroll to first error
                const firstError = document.querySelector('.border-red-500');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        });
    }
});
</script>

<style>
/* Custom styles for checkout form */
input:focus, textarea:focus, select:focus {
    outline: none;
    ring: 2px;
}

.border-red-500 {
    border-color: #ef4444;
}

.focus\:border-red-500:focus {
    border-color: #ef4444;
}

.focus\:ring-red-500:focus {
    --tw-ring-color: #ef4444;
}

/* Loading animation */
@keyframes spin {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

.animate-spin {
    animation: spin 1s linear infinite;
}
</style>
{% endblock %}